# Harmonise FinScope

This repository harmonises repeated cross-sectional FinScope Consumer South Africa surveys into a consistent time series of key indicators. The aim is to let researchers track financial inclusion, insurance take-up, livelihood indicators, and related behaviours through time without wrestling with changing survey wording.

## Project layout

```
mappings/        # easy-to-edit CSV lookup tables that drive harmonisation
docs/            # narrative notes on survey waves and harmonisation decisions
scripts/         # lightweight command line helpers (clean, harmonise, summarise)
notebooks/       # exploratory work; final logic should live in `scripts/`
outputs/         # harmonised CSVs generated by the scripts
utils.py         # shared helpers (e.g. loading FinScope files)
```

Economists can update the mappings directly in a spreadsheet editor—no need to touch application code unless the logic itself changes.

## Prerequisites

1. Python ≥3.10 with `pandas`, `numpy`, `pyreadstat`, `python-dotenv`.
2. Set the environment variable `DATA_PATH` (e.g. in a `.env` file) to the directory containing your FinScope survey extracts. The loaders expect files in `DATA_PATH/finscope/dta/FS_{year}.dta`.

## Typical workflow

1. **Point to the raw files**  
   Ensure `DATA_PATH` references the OneDrive (or other shared location) that stores the FinScope extracts in `finscope/dta/FS_{year}.dta`.

2. **(Optional) Clean a single wave**  
   Use the convenience script (or `make single`) to subset columns or export a smaller CSV/Parquet file:
   ```
   make single  # prompts for the year interactively
   # or:
   python scripts/clean_year.py 2019 --keep-columns H3a_13 i1_10 --output-format parquet
   ```
   Outputs are written locally next to your project (default `outputs/finscope_{year}_clean.*`).

3. **Review or extend mappings**  
   Open `mappings/harmonised_questions.csv` in Excel/LibreOffice to adjust question codes, response values, or to add new indicators. Each row corresponds to a survey year and indicator, with human-readable labels and simple instructions (single column vs prefix match). Use `docs/harmonisation_notes.md` to record questionnaire quirks or rationale as you refine the mappings.

4. **Generate the harmonised table**  
   ```
   make harmonise
   ```
   This reads the mapping file, applies the correct weights specified in `mappings/year_weights.csv`, and writes both `outputs/finscope_harmonised.csv` and `outputs/finscope_harmonised_long.csv`. Use `python scripts/harmonise.py` directly if you need custom arguments.

5. **Inspect the result**  
   ```
   make summary
   ```
   This prints the weighted shares by year and refreshes the long-format export for downstream analysis.

Common maintenance commands live in the `Makefile`; run `make` without arguments to see the available targets (including `clean` to remove generated CSVs).

## Adding new indicators

1. Identify the relevant question IDs and response codes for each survey year.
2. Add a row to `mappings/harmonised_questions.csv` for the new indicator and year. Use `field_type=column` to list explicit variable names (`Q216_I`), or `field_type=prefix` to grab a whole block (`I1_`), excluding the main indicator when necessary.
3. Re-run `make harmonise` (or call `python scripts/harmonise.py` directly if you need custom arguments) to regenerate the wide table.

The repository keeps configuration lightweight and spreadsheet-friendly so subject-matter experts can maintain recodes without navigating a complex software stack. Reach for notebooks in `notebooks/` for exploratory checks, but migrate stable logic back into the scripts for reproducibility.
